{% extends "base.html" %}

{% block title %}Projects Management - Portfolio Admin{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h2>Projects Management</h2>
    </div>
    <div class="col text-end">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProjectModal">
            <i class="bi bi-plus-circle"></i> Add New Project
        </button>
    </div>
</div>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-body">
        <form id="filterForm" class="row g-3">
            <div class="col-md-4">
                <label for="search" class="form-label">Search</label>
                <input type="text" class="form-control" id="search" placeholder="Search by title or technologies...">
            </div>
            <div class="col-md-3">
                <label for="featured" class="form-label">Featured</label>
                <select class="form-select" id="featured">
                    <option value="">All</option>
                    <option value="true">Featured</option>
                    <option value="false">Not Featured</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="sortBy" class="form-label">Sort By</label>
                <select class="form-select" id="sortBy">
                    <option value="title">Title</option>
                    <option value="created_at">Date Added</option>
                </select>
            </div>
            <div class="col-md-2">
                <label for="sortOrder" class="form-label">Order</label>
                <select class="form-select" id="sortOrder">
                    <option value="asc">Ascending</option>
                    <option value="desc">Descending</option>
                </select>
            </div>
        </form>
    </div>
</div>

<!-- Projects List -->
<div class="table-responsive">
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Title</th>
                <th>Technologies</th>
                <th>Featured</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="projectsList">
            <!-- Projects will be loaded here dynamically -->
        </tbody>
    </table>
</div>

<!-- Add Project Modal -->
<div class="modal fade" id="addProjectModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Project</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="projectForm">
                    <div class="mb-3">
                        <label for="title" class="form-label">Title</label>
                        <input type="text" class="form-control" id="title" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="technologies" class="form-label">Technologies (comma-separated)</label>
                        <input type="text" class="form-control" id="technologies" name="technologies" required>
                    </div>
                    <div class="mb-3">
                        <label for="images" class="form-label">Project Images (Multiple)</label>
                        <input type="file" class="form-control" id="images" name="images" accept="image/*" multiple>
                        <div id="imagesPreview" class="mt-2" style="display: none;">
                            <div id="imagesPreviewContainer" class="d-flex flex-wrap gap-2"></div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="image_urls" class="form-label">Image URLs (comma-separated, if not uploading)</label>
                        <input type="text" class="form-control" id="image_urls" name="image_urls" placeholder="https://example.com/image1.jpg, https://example.com/image2.jpg">
                    </div>
                    <div class="mb-3">
                        <label for="github_url" class="form-label">GitHub URL</label>
                        <input type="url" class="form-control" id="github_url" name="github_url">
                    </div>
                    <div class="mb-3">
                        <label for="live_url" class="form-label">Live URL</label>
                        <input type="url" class="form-control" id="live_url" name="live_url">
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="featured" name="featured">
                        <label class="form-check-label" for="featured">Featured Project</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveProject()">Save Project</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Project Modal -->
<div class="modal fade" id="editProjectModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Project</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editProjectForm">
                    <input type="hidden" id="edit_id" name="id">
                    <div class="mb-3">
                        <label for="edit_title" class="form-label">Title</label>
                        <input type="text" class="form-control" id="edit_title" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_description" class="form-label">Description</label>
                        <textarea class="form-control" id="edit_description" name="description" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="edit_technologies" class="form-label">Technologies (comma-separated)</label>
                        <input type="text" class="form-control" id="edit_technologies" name="technologies" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_images" class="form-label">Project Images (Multiple)</label>
                        <input type="file" class="form-control" id="edit_images" name="images" accept="image/*" multiple>
                        <div id="editImagesPreview" class="mt-2">
                            <div id="editImagesPreviewContainer" class="d-flex flex-wrap gap-2"></div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="edit_image_urls" class="form-label">Image URLs (comma-separated, if not uploading)</label>
                        <input type="text" class="form-control" id="edit_image_urls" name="image_urls" placeholder="https://example.com/image1.jpg, https://example.com/image2.jpg">
                    </div>
                    <div class="mb-3">
                        <label for="edit_github_url" class="form-label">GitHub URL</label>
                        <input type="url" class="form-control" id="edit_github_url" name="github_url">
                    </div>
                    <div class="mb-3">
                        <label for="edit_live_url" class="form-label">Live URL</label>
                        <input type="url" class="form-control" id="edit_live_url" name="live_url">
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="edit_featured" name="featured">
                        <label class="form-check-label" for="edit_featured">Featured Project</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="updateProject()">Update Project</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Load projects on page load
document.addEventListener('DOMContentLoaded', () => {
    loadProjects();
    setupFilters();
});

let projects = [];

function setupFilters() {
    const filterInputs = ['search', 'featured', 'sortBy', 'sortOrder'];
    filterInputs.forEach(input => {
        document.getElementById(input).addEventListener('change', filterAndSortProjects);
    });
    document.getElementById('search').addEventListener('input', filterAndSortProjects);
}

function filterAndSortProjects() {
    const searchTerm = document.getElementById('search').value.toLowerCase();
    const featuredFilter = document.getElementById('featured').value;
    const sortBy = document.getElementById('sortBy').value;
    const sortOrder = document.getElementById('sortOrder').value;

    let filteredProjects = projects.filter(project => {
        const matchesSearch = project.title.toLowerCase().includes(searchTerm) ||
                            project.technologies.some(tech => tech.toLowerCase().includes(searchTerm));
        const matchesFeatured = featuredFilter === '' || project.featured.toString() === featuredFilter;
        return matchesSearch && matchesFeatured;
    });

    filteredProjects.sort((a, b) => {
        let comparison = 0;
        if (sortBy === 'title') {
            comparison = a.title.localeCompare(b.title);
        } else if (sortBy === 'created_at') {
            comparison = new Date(a.created_at) - new Date(b.created_at);
        }
        return sortOrder === 'asc' ? comparison : -comparison;
    });

    displayProjects(filteredProjects);
}

function displayProjects(projectsToDisplay) {
    const projectsList = document.getElementById('projectsList');
    projectsList.innerHTML = projectsToDisplay.map(project => `
        <tr>
            <td>${project.title}</td>
            <td>${project.technologies.join(', ')}</td>
            <td>${project.featured ? 'Yes' : 'No'}</td>
            <td>
                <button class="btn btn-sm btn-primary" onclick="editProject(${project.id})">
                    <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteProject(${project.id})">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

async function loadProjects() {
    try {
        const response = await fetch('/api/admin/projects');
        projects = await response.json();
        filterAndSortProjects();
    } catch (error) {
        console.error('Error loading projects:', error);
        alert('Error loading projects');
    }
}

// Add multiple images preview functionality
document.getElementById('images').addEventListener('change', function(e) {
    const files = e.target.files;
    const previewContainer = document.getElementById('imagesPreviewContainer');
    const preview = document.getElementById('imagesPreview');

    previewContainer.innerHTML = '';

    if (files && files.length > 0) {
        preview.style.display = 'block';
        Array.from(files).forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.style.maxWidth = '100px';
                img.style.maxHeight = '100px';
                img.style.objectFit = 'cover';
                img.style.borderRadius = '4px';
                img.style.margin = '2px';
                previewContainer.appendChild(img);
            }
            reader.readAsDataURL(file);
        });
    } else {
        preview.style.display = 'none';
    }
});

async function saveProject() {
    const form = document.getElementById('projectForm');
    const formData = new FormData(form);
    const imageFiles = document.getElementById('images').files;
    const imageUrlsInput = formData.get('image_urls');

    try {
        let imageUrls = [];

        // If image files are selected, upload them first
        if (imageFiles && imageFiles.length > 0) {
            const uploadFormData = new FormData();
            Array.from(imageFiles).forEach(file => {
                uploadFormData.append('files', file);
            });

            const uploadResponse = await fetch('/api/upload/images', {
                method: 'POST',
                body: uploadFormData
            });

            if (!uploadResponse.ok) {
                throw new Error('Failed to upload images');
            }

            const uploadResult = await uploadResponse.json();
            imageUrls = uploadResult.urls;
        } else if (imageUrlsInput && imageUrlsInput.trim()) {
            // Parse comma-separated URLs
            imageUrls = imageUrlsInput.split(',').map(url => url.trim()).filter(url => url);
        }

        const project = {
            title: formData.get('title'),
            description: formData.get('description'),
            technologies: formData.get('technologies').split(',').map(t => t.trim()),
            image_urls: imageUrls,
            github_url: formData.get('github_url'),
            live_url: formData.get('live_url'),
            featured: formData.get('featured') === 'on'
        };

        const response = await fetch('/api/admin/projects', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(project)
        });

        if (!response.ok) {
            throw new Error('Failed to save project');
        }

        // Close modal and refresh projects
        const modal = bootstrap.Modal.getInstance(document.getElementById('addProjectModal'));
        modal.hide();
        form.reset();
        document.getElementById('imagesPreview').style.display = 'none';
        document.getElementById('imagesPreviewContainer').innerHTML = '';
        loadProjects();
    } catch (error) {
        console.error('Error saving project:', error);
        alert('Error saving project: ' + error.message);
    }
}

// Add multiple images preview functionality for edit form
document.getElementById('edit_images').addEventListener('change', function(e) {
    const files = e.target.files;
    const previewContainer = document.getElementById('editImagesPreviewContainer');
    const preview = document.getElementById('editImagesPreview');

    previewContainer.innerHTML = '';

    if (files && files.length > 0) {
        preview.style.display = 'block';
        Array.from(files).forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.style.maxWidth = '100px';
                img.style.maxHeight = '100px';
                img.style.objectFit = 'cover';
                img.style.borderRadius = '4px';
                img.style.margin = '2px';
                previewContainer.appendChild(img);
            }
            reader.readAsDataURL(file);
        });
    } else {
        preview.style.display = 'none';
    }
});

async function editProject(id) {
    try {
        const response = await fetch(`/api/admin/projects/${id}`);
        const project = await response.json();

        document.getElementById('edit_id').value = project.id;
        document.getElementById('edit_title').value = project.title;
        document.getElementById('edit_description').value = project.description;
        document.getElementById('edit_technologies').value = project.technologies.join(', ');
        document.getElementById('edit_image_urls').value = (project.image_urls || []).join(', ');
        document.getElementById('edit_github_url').value = project.github_url || '';
        document.getElementById('edit_live_url').value = project.live_url || '';
        document.getElementById('edit_featured').checked = project.featured;

        // Show current images preview if exists
        const preview = document.getElementById('editImagesPreview');
        const previewContainer = document.getElementById('editImagesPreviewContainer');
        if (project.image_urls && project.image_urls.length > 0) {
            preview.style.display = 'block';
            previewContainer.innerHTML = project.image_urls.map(url =>
                `<img src="${url}" style="max-width: 100px; max-height: 100px; object-fit: cover; border-radius: 4px; margin: 2px;">`
            ).join('');
        } else {
            preview.style.display = 'none';
            previewContainer.innerHTML = '';
        }

        const modal = new bootstrap.Modal(document.getElementById('editProjectModal'));
        modal.show();
    } catch (error) {
        console.error('Error loading project:', error);
        alert('Error loading project');
    }
}

async function updateProject() {
    const form = document.getElementById('editProjectForm');
    const formData = new FormData(form);
    const imageFiles = document.getElementById('edit_images').files;
    const projectId = formData.get('id');
    const imageUrlsInput = formData.get('image_urls');

    try {
        let imageUrls = [];

        // If image files are selected, upload them first
        if (imageFiles && imageFiles.length > 0) {
            const uploadFormData = new FormData();
            Array.from(imageFiles).forEach(file => {
                uploadFormData.append('files', file);
            });
            uploadFormData.append('project_id', projectId);

            const uploadResponse = await fetch('/api/upload/images', {
                method: 'POST',
                body: uploadFormData
            });

            if (!uploadResponse.ok) {
                throw new Error('Failed to upload images');
            }

            const uploadResult = await uploadResponse.json();
            imageUrls = uploadResult.urls;
        } else if (imageUrlsInput && imageUrlsInput.trim()) {
            // Parse comma-separated URLs
            imageUrls = imageUrlsInput.split(',').map(url => url.trim()).filter(url => url);
        }

        const project = {
            title: formData.get('title'),
            description: formData.get('description'),
            technologies: formData.get('technologies').split(',').map(t => t.trim()),
            image_urls: imageUrls,
            github_url: formData.get('github_url'),
            live_url: formData.get('live_url'),
            featured: formData.get('featured') === 'on'
        };

        const response = await fetch(`/api/admin/projects/${projectId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(project)
        });

        if (!response.ok) {
            throw new Error('Failed to update project');
        }

        // Close modal and refresh projects
        const modal = bootstrap.Modal.getInstance(document.getElementById('editProjectModal'));
        modal.hide();
        form.reset();
        document.getElementById('editImagesPreview').style.display = 'none';
        document.getElementById('editImagesPreviewContainer').innerHTML = '';
        loadProjects();
    } catch (error) {
        console.error('Error updating project:', error);
        alert('Error updating project: ' + error.message);
    }
}

async function deleteProject(id) {
    if (!confirm('Are you sure you want to delete this project?')) {
        return;
    }

    try {
        const response = await fetch(`/api/admin/projects/${id}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            loadProjects();
        } else {
            throw new Error('Failed to delete project');
        }
    } catch (error) {
        console.error('Error deleting project:', error);
        alert('Error deleting project');
    }
}
</script>
{% endblock %} 