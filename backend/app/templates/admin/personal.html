{% extends "base.html" %}

{% block title %}Personal Data - Admin Dashboard{% endblock %}

{% block content %}
<div class="container py-4">
    <h1 class="h2 mb-4">Personal Data</h1>
    
    <div class="card shadow-sm">
        <div class="card-body">
            <form id="personalDataForm">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="name" class="form-label">Name</label>
                        <input type="text" id="name" name="name" class="form-control">
                    </div>
                    
                    <div class="col-md-6">
                        <label for="title" class="form-label">Title</label>
                        <input type="text" id="title" name="title" class="form-control">
                    </div>

                    <div class="col-md-6">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" id="email" name="email" class="form-control">
                    </div>

                    <div class="col-md-6">
                        <label for="phone" class="form-label">Phone</label>
                        <input type="tel" id="phone" name="phone" class="form-control">
                    </div>

                    <div class="col-12">
                        <label for="location" class="form-label">Location</label>
                        <input type="text" id="location" name="location" class="form-control">
                    </div>

                    <div class="col-12">
                        <label for="bio" class="form-label">Bio</label>
                        <textarea id="bio" name="bio" rows="4" class="form-control"></textarea>
                    </div>

                    <div class="col-12">
                        <label for="skills" class="form-label">Skills (comma-separated)</label>
                        <input type="text" id="skills" name="skills" class="form-control">
                    </div>

                    <div class="col-md-6">
                        <label for="avatar_file" class="form-label">Avatar Image</label>
                        <input type="file" id="avatar_file" name="avatar_file" class="form-control" accept="image/*">
                        <div class="form-text">Upload a profile picture (max 5MB)</div>
                        <div id="current-avatar" class="mt-2"></div>
                    </div>

                    <div class="col-md-6">
                        <label for="photo_file" class="form-label">Additional Photo</label>
                        <input type="file" id="photo_file" name="photo_file" class="form-control" accept="image/*">
                        <div class="form-text">Upload an additional photo (max 5MB)</div>
                        <div id="current-photo" class="mt-2"></div>
                    </div>

                    <div class="col-md-6">
                        <label for="github_url" class="form-label">GitHub URL</label>
                        <input type="url" id="github_url" name="github_url" class="form-control" placeholder="https://github.com/username">
                    </div>

                    <div class="col-md-6">
                        <label for="linkedin_url" class="form-label">LinkedIn URL</label>
                        <input type="url" id="linkedin_url" name="linkedin_url" class="form-control" placeholder="https://linkedin.com/in/username">
                    </div>

                    <div class="col-md-6">
                        <label for="twitter_url" class="form-label">Twitter URL (Optional)</label>
                        <input type="url" id="twitter_url" name="twitter_url" class="form-control" placeholder="https://twitter.com/username">
                    </div>

                    <div class="col-md-6">
                        <label for="instagram_url" class="form-label">Instagram URL (Optional)</label>
                        <input type="url" id="instagram_url" name="instagram_url" class="form-control" placeholder="https://instagram.com/username">
                    </div>
                </div>

                <div class="d-flex justify-content-end mt-4">
                    <button type="submit" class="btn btn-primary">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
    const form = document.getElementById('personalDataForm');
    
    // Fetch existing data
    try {
        const response = await fetch('/api/admin/personal');
        if (response.ok) {
            const data = await response.json();
            if (data) {
                // Populate form fields
                Object.keys(data).forEach(key => {
                    const input = form.elements[key];
                    if (input) {
                        if (key === 'social_links' && data[key]) {
                            // Handle individual social links
                            if (data[key].github) document.getElementById('github_url').value = data[key].github;
                            if (data[key].linkedin) document.getElementById('linkedin_url').value = data[key].linkedin;
                            if (data[key].twitter) document.getElementById('twitter_url').value = data[key].twitter;
                            if (data[key].instagram) document.getElementById('instagram_url').value = data[key].instagram;
                        } else if (key === 'skills') {
                            input.value = data[key].join(', ');
                        } else if (key === 'avatar_url' && data[key]) {
                            // Show current avatar
                            const avatarDiv = document.getElementById('current-avatar');
                            avatarDiv.innerHTML = `<img src="${data[key]}" alt="Current Avatar" style="max-width: 100px; max-height: 100px; border-radius: 8px;">`;
                        } else if (key === 'photo_url' && data[key]) {
                            // Show current photo
                            const photoDiv = document.getElementById('current-photo');
                            photoDiv.innerHTML = `<img src="${data[key]}" alt="Current Photo" style="max-width: 100px; max-height: 100px; border-radius: 8px;">`;
                        } else {
                            input.value = data[key];
                        }
                    }
                });
            }
        }
    } catch (error) {
        console.error('Error fetching personal data:', error);
    }

    // Handle form submission
    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = new FormData(form);
        const data = {};

        // Handle file uploads first
        const avatarFile = formData.get('avatar_file');
        const photoFile = formData.get('photo_file');

        // Upload avatar if provided
        if (avatarFile && avatarFile.size > 0) {
            try {
                const avatarFormData = new FormData();
                avatarFormData.append('file', avatarFile);
                const avatarResponse = await fetch('/api/upload/image', {
                    method: 'POST',
                    body: avatarFormData,
                });
                if (avatarResponse.ok) {
                    const avatarResult = await avatarResponse.json();
                    data.avatar_url = avatarResult.url;
                }
            } catch (error) {
                console.error('Error uploading avatar:', error);
                alert('Error uploading avatar');
                return;
            }
        }

        // Upload photo if provided
        if (photoFile && photoFile.size > 0) {
            try {
                const photoFormData = new FormData();
                photoFormData.append('file', photoFile);
                const photoResponse = await fetch('/api/upload/image', {
                    method: 'POST',
                    body: photoFormData,
                });
                if (photoResponse.ok) {
                    const photoResult = await photoResponse.json();
                    data.photo_url = photoResult.url;
                }
            } catch (error) {
                console.error('Error uploading photo:', error);
                alert('Error uploading photo');
                return;
            }
        }

        // Process other form fields
        for (const [key, value] of formData.entries()) {
            if (key === 'skills') {
                data[key] = value.split(',').map(skill => skill.trim()).filter(Boolean);
            } else if (!key.includes('_file')) { // Skip file inputs
                data[key] = value;
            }
        }

        // Build social_links object from individual fields
        const socialLinks = {};
        if (data.github_url) socialLinks.github = data.github_url;
        if (data.linkedin_url) socialLinks.linkedin = data.linkedin_url;
        if (data.twitter_url) socialLinks.twitter = data.twitter_url;
        if (data.instagram_url) socialLinks.instagram = data.instagram_url;

        if (Object.keys(socialLinks).length > 0) {
            data.social_links = socialLinks;
        }

        // Remove individual social link fields from data
        delete data.github_url;
        delete data.linkedin_url;
        delete data.twitter_url;
        delete data.instagram_url;

        try {
            const response = await fetch('/api/admin/personal', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            });

            if (response.ok) {
                alert('Personal data saved successfully!');
                // Refresh the page to show updated images
                window.location.reload();
            } else {
                const error = await response.json();
                alert(`Error: ${error.detail}`);
            }
        } catch (error) {
            console.error('Error saving personal data:', error);
            alert('Error saving personal data');
        }
    });
});
</script>
{% endblock %} 